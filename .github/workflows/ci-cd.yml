# CI/CD Pipeline for Spanish Vocabulary App
# This workflow automatically tests and deploys your application

name: CI/CD Pipeline

# TRIGGERS: When should this workflow run?
on:
  # Run on pushes to main branch
  push:
    branches: [ main ]

  # Run on pull requests targeting main branch
  pull_request:
    branches: [ main ]

  # Allow manual triggering from GitHub UI (useful for testing)
  workflow_dispatch:

# JOBS: The actual work to be done
jobs:

  # JOB 1: TEST
  # This job runs your tests to ensure code quality
  test:
    name: Run Tests
    runs-on: ubuntu-latest  # Use Ubuntu Linux virtual machine

    # POSTGRESQL SERVICE
    # Spin up PostgreSQL in a Docker container for testing
    services:
      postgres:
        image: postgres:15
        # Set up PostgreSQL with test credentials
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        # Health checks ensure PostgreSQL is ready before tests run
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        # Expose PostgreSQL on port 5432
        ports:
          - 5432:5432

    steps:
      # STEP 1: Get the code
      # This clones your repository to the GitHub Actions runner
      - name: Checkout code
        uses: actions/checkout@v4
        # 'uses' means we're using a pre-built action from GitHub marketplace
        # actions/checkout is maintained by GitHub and clones your repo

      # STEP 2: Set up Python
      # Install Python on the virtual machine
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          # 'with' passes parameters to the action
          # We specify Python 3.9 to match your local environment

      # STEP 3: Cache dependencies (speeds up builds)
      # This saves your installed packages so we don't reinstall every time
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          # Where pip stores downloaded packages
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          # Unique key based on OS and requirements.txt contents
          # If requirements.txt changes, cache is invalidated
          restore-keys: |
            ${{ runner.os }}-pip-

      # STEP 4: Install dependencies
      # Install all packages from requirements.txt
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        # 'run' executes shell commands
        # This is like running these commands in your terminal

      # STEP 5: Run the tests
      # Execute pytest with coverage reporting against PostgreSQL
      - name: Run tests with coverage
        env:
          # Point to the PostgreSQL service
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        run: |
          pytest --cov=. --cov-report=term-missing --cov-report=html -v
        # Tests now run against PostgreSQL (same as production)
        # This catches PostgreSQL-specific issues before deployment
        # --cov=. : Measure coverage for all Python files in current directory
        # --cov-report=term-missing : Show which lines aren't tested
        # --cov-report=html : Generate HTML coverage report
        # -v : Verbose output (show each test name)

      # STEP 6: Upload coverage report
      # Save the HTML coverage report as an artifact
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if tests fail
        with:
          name: coverage-report
          path: htmlcov/
          # You can download this from GitHub Actions UI to see detailed coverage

  # JOB 2: CODE QUALITY (Optional but recommended)
  # Check code style and quality
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install linting tools
        run: |
          pip install flake8 black
        # flake8: Checks code style (PEP 8 compliance)
        # black: Code formatter (checks if code is formatted correctly)

      - name: Run flake8
        run: |
          # Check for Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # E9: Runtime errors
          # F63: Invalid syntax
          # F7: Syntax errors
          # F82: Undefined names

          # Check for code style issues (warnings only, won't fail the build)
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true  # Don't fail the build on style issues (yet)

      - name: Check code formatting with black
        run: |
          black --check --diff .
        continue-on-error: true  # Don't fail the build on formatting issues (yet)

  # JOB 3: DEPLOY TO EC2
  # Deploy to AWS EC2 only if tests pass
  deploy-ec2:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    needs: [test, lint]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Navigate to app directory
            cd ~/spanish-vocab

            # Pull latest code
            git pull origin main

            # Install/update Node.js dependencies
            npm install

            # Build production CSS
            npm run build:css:prod

            # Install/update Python dependencies
            source venv/bin/activate
            pip install -r requirements.txt

            # Run database migrations
            python3 -m flask db upgrade

            # Restart the application
            sudo systemctl restart spanish-vocab

            # Check if service is running
            sudo systemctl status spanish-vocab --no-pager

      - name: Deployment notification
        run: |
          echo "üöÄ EC2 deployment completed successfully!"
          echo "‚úÖ CSS built and optimized"
          echo "üåê App is live at https://spanish-vocab.duckdns.org"

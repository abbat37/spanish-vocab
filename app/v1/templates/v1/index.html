<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Word Learner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
</head>
<body class="min-h-screen bg-gradient-to-br from-calm-100 via-calm-50 to-primary-50">
    <!-- Header -->
    <header class="bg-calm-50 border-b border-calm-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo and Title -->
                <div class="flex items-center space-x-3">
                    <div class="flex items-center justify-center w-10 h-10 bg-gradient-to-br from-primary-500 to-primary-600 rounded-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                    </div>
                    <h1 class="text-xl font-bold text-calm-900 hidden sm:block">Spanish Learner</h1>
                </div>

                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center space-x-4">
                    <a href="/v2/" class="px-4 py-2 text-sm font-semibold text-white bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition duration-200">
                        Try V2 Beta →
                    </a>
                    <span class="text-sm text-calm-600">{{ current_user.email }}</span>
                    <a href="{{ url_for('auth.logout') }}" class="px-4 py-2 text-sm font-medium text-primary-600 hover:text-primary-700 hover:bg-primary-50 rounded-lg transition duration-200">
                        Sign Out
                    </a>
                </div>

                <!-- Mobile Menu Button -->
                <button id="mobile-menu-button" type="button" class="md:hidden inline-flex items-center justify-center p-2 rounded-lg text-calm-600 hover:text-calm-900 hover:bg-calm-100 transition duration-200" aria-expanded="false">
                    <span class="sr-only">Open menu</span>
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden border-t border-calm-200">
            <div class="px-4 py-3 space-y-3">
                <div class="text-sm text-calm-600 pb-2 border-b border-calm-200">{{ current_user.email }}</div>
                <a href="/v2/" class="block px-4 py-2 text-sm font-semibold text-white bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 rounded-lg shadow-md hover:shadow-lg transition duration-200 text-center">
                    Try V2 Beta →
                </a>
                <a href="{{ url_for('auth.logout') }}" class="block px-4 py-2 text-sm font-medium text-primary-600 hover:bg-primary-50 rounded-lg transition duration-200">
                    Sign Out
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
        <!-- Page Title -->
        <div class="mb-6">
            <h2 class="text-2xl sm:text-3xl font-bold text-calm-900 mb-2">Your Learning Dashboard</h2>
            <p class="text-calm-600">Practice Spanish vocabulary with context-rich sentences</p>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-6">
                    {% for category, message in messages %}
                        <div class="{% if category == 'success' %}bg-green-50 border-green-200 text-green-800{% else %}bg-red-50 border-red-200 text-red-800{% endif %} border rounded-lg px-4 py-3 text-sm mb-3">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 mr-2 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                    {% if category == 'success' %}
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    {% else %}
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                    {% endif %}
                                </svg>
                                <span>{{ message }}</span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Stats Dashboard -->
        {% if stats and stats.total_practiced > 0 %}
        <div class="bg-white rounded-xl shadow-sm border border-calm-200 p-6 mb-6">
            <h3 class="text-lg font-semibold text-calm-900 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-primary-600" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
                </svg>
                Your Progress
            </h3>

            <!-- Row 1: Total Stats (Always visible) -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-gradient-to-br from-primary-50 to-primary-100 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-primary-600 mb-1">{{ stats.total_practiced }}</div>
                    <div class="text-xs text-calm-600 uppercase tracking-wide">Words Practiced</div>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-green-600 mb-1">{{ stats.total_learned }}</div>
                    <div class="text-xs text-calm-600 uppercase tracking-wide">Marked Learned</div>
                </div>
            </div>

            <!-- Row 2: Theme Breakdown (Hidden on mobile, visible on desktop) -->
            <div class="hidden lg:grid lg:grid-cols-4 gap-4">
                {% for theme_name in ['cooking', 'work', 'sports', 'restaurant'] %}
                <div class="bg-gradient-to-br from-calm-50 to-calm-100 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-calm-700 mb-1">{{ stats.by_theme.get(theme_name, 0) }}</div>
                    <div class="text-xs text-calm-600 uppercase tracking-wide">{{ theme_name|title }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Main Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Sidebar: Form -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-sm border border-calm-200 p-6 lg:sticky lg:top-24" style="min-height: 360px;">
                    <h3 class="text-lg font-semibold text-calm-900 mb-4">Generate Practice</h3>
                    <form method="POST" class="space-y-4" id="generate-form">
                        <!-- Theme Select -->
                        <div>
                            <label for="theme" class="block text-sm font-medium text-calm-700 mb-2">
                                Theme
                            </label>
                            <select
                                id="theme"
                                name="theme"
                                required
                                class="w-full px-4 py-2.5 bg-calm-50 border border-calm-200 rounded-lg text-calm-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition duration-200"
                            >
                                <option value="">Choose theme...</option>
                                <option value="cooking" {% if theme == 'cooking' %}selected{% endif %}>Cooking</option>
                                <option value="work" {% if theme == 'work' %}selected{% endif %}>Work</option>
                                <option value="sports" {% if theme == 'sports' %}selected{% endif %}>Sports</option>
                                <option value="restaurant" {% if theme == 'restaurant' %}selected{% endif %}>Restaurant</option>
                            </select>
                        </div>

                        <!-- Word Type Select -->
                        <div>
                            <label for="word_type" class="block text-sm font-medium text-calm-700 mb-2">
                                Word Type
                            </label>
                            <select
                                id="word_type"
                                name="word_type"
                                required
                                class="w-full px-4 py-2.5 bg-calm-50 border border-calm-200 rounded-lg text-calm-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition duration-200"
                            >
                                <option value="">Choose type...</option>
                                <option value="verb" {% if word_type == 'verb' %}selected{% endif %}>Verb</option>
                                <option value="noun" {% if word_type == 'noun' %}selected{% endif %}>Noun</option>
                                <option value="adj" {% if word_type == 'adj' %}selected{% endif %}>Adjective</option>
                            </select>
                        </div>

                        <!-- Submit Button -->
                        <button
                            type="submit"
                            id="generate-button"
                            class="w-full bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition duration-200"
                        >
                            <span id="button-text">Generate Sentences</span>
                            <span id="button-loading" class="hidden">
                                <svg class="inline w-4 h-4 animate-spin mr-2" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Generating...
                            </span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Main Content: Sentences -->
            <div class="lg:col-span-3" id="sentences-section">
                {% if sentences %}
                <div class="space-y-4">
                    {% for sentence in sentences %}
                    <div class="bg-white rounded-xl shadow-sm border border-calm-200 p-5 hover:shadow-md transition-shadow duration-200">
                        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
                            <div class="flex-1 min-w-0">
                                <div class="text-lg text-calm-900 mb-2 leading-relaxed">
                                    {{ sentence.spanish|safe }}
                                </div>
                                <div class="text-base text-calm-600 leading-relaxed">
                                    {{ sentence.english|safe }}
                                </div>
                            </div>
                            <button
                                class="learn-btn flex-shrink-0 px-4 py-2 rounded-lg text-sm font-medium transition duration-200 {% if sentence.is_learned %}bg-green-100 text-green-700 hover:bg-green-200{% else %}bg-primary-100 text-primary-700 hover:bg-primary-200{% endif %}"
                                data-word-id="{{ sentence.word_id }}"
                                data-is-learned="{{ sentence.is_learned|lower }}"
                            >
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    {% if sentence.is_learned %}Learned{% else %}Mark Learned{% endif %}
                                </span>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% elif theme and word_type %}
                <div class="bg-white rounded-xl shadow-sm border border-calm-200 p-12 text-center">
                    <svg class="w-16 h-16 text-calm-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-calm-600 text-lg">No sentences found for this combination.</p>
                    <p class="text-calm-500 text-sm mt-2">Try selecting a different theme or word type.</p>
                </div>
                {% else %}
                <div class="bg-white rounded-xl shadow-sm border border-calm-200 p-6 flex flex-col items-center justify-center" style="min-height: 360px;">
                    <svg class="w-10 h-10 text-primary-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>
                    <p class="text-calm-600">Select a theme and word type to begin</p>
                    <p class="text-calm-500 text-sm mt-1">Practice Spanish vocabulary with contextual sentences</p>
                </div>
                {% endif %}
            </div>
        </div>
    </main>

    <!-- Mobile Menu Script -->
    <script src="{{ url_for('static', filename='js/mobile-menu.js') }}"></script>

    <!-- Mark Learned Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-scroll to sentences after form submission (if sentences exist)
            {% if sentences %}
            const sentencesSection = document.getElementById('sentences-section');
            if (sentencesSection && window.innerWidth < 1024) { // Only on mobile/tablet
                // Small delay to ensure page is fully loaded
                setTimeout(() => {
                    sentencesSection.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }, 100);
            }
            {% endif %}

            // Add loading state to form submission
            const generateForm = document.getElementById('generate-form');
            const generateButton = document.getElementById('generate-button');
            const buttonText = document.getElementById('button-text');
            const buttonLoading = document.getElementById('button-loading');

            if (generateForm) {
                generateForm.addEventListener('submit', function(e) {
                    // Show loading state
                    if (buttonText && buttonLoading) {
                        buttonText.classList.add('hidden');
                        buttonLoading.classList.remove('hidden');
                        generateButton.disabled = true;
                        generateButton.classList.add('opacity-75', 'cursor-not-allowed');
                    }
                });
            }

            document.body.addEventListener('click', function(e) {
                if (e.target.closest('.learn-btn')) {
                    const button = e.target.closest('.learn-btn');
                    const wordId = parseInt(button.getAttribute('data-word-id'));
                    markLearned(wordId, button);
                }
            });
        });

        function markLearned(wordId, button) {
            fetch('/api/mark-learned', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ word_id: wordId })
            })
            .then(response => {
                if (response.status === 429) {
                    showRateLimitWarning(button);
                    throw new Error('Rate limited');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Update button appearance
                    if (data.marked_learned) {
                        button.classList.remove('bg-primary-100', 'text-primary-700', 'hover:bg-primary-200');
                        button.classList.add('bg-green-100', 'text-green-700', 'hover:bg-green-200');
                        button.querySelector('span').innerHTML = `
                            <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            Learned
                        `;
                    } else {
                        button.classList.remove('bg-green-100', 'text-green-700', 'hover:bg-green-200');
                        button.classList.add('bg-primary-100', 'text-primary-700', 'hover:bg-primary-200');
                        button.querySelector('span').innerHTML = `
                            <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            Mark Learned
                        `;
                    }
                    button.setAttribute('data-is-learned', data.marked_learned);

                    // Update stats
                    if (data.stats) {
                        updateStats(data.stats);
                    }
                }
            })
            .catch(error => {
                if (error.message !== 'Rate limited') {
                    console.error('Error:', error);
                    showNotification(button, 'Failed to update', 'error');
                }
            });
        }

        function showRateLimitWarning(button) {
            const originalContent = button.innerHTML;
            const originalClasses = button.className;

            // Apply warning styling
            button.className = 'flex-shrink-0 px-4 py-2 rounded-lg text-sm font-medium transition duration-200 bg-amber-100 text-amber-800';
            button.innerHTML = '<span class="flex items-center">⏱️ Too fast!</span>';

            setTimeout(() => {
                button.className = originalClasses;
                button.innerHTML = originalContent;
            }, 2500);
        }

        function updateStats(stats) {
            // Update stats in the dashboard
            const statElements = document.querySelectorAll('.text-3xl.font-bold');
            if (statElements.length >= 2) {
                statElements[0].textContent = stats.total_practiced;
                statElements[1].textContent = stats.total_learned;
            }

            // Update theme stats if present
            if (stats.by_theme && statElements.length > 2) {
                let index = 2;
                for (const [theme, count] of Object.entries(stats.by_theme)) {
                    if (statElements[index]) {
                        statElements[index].textContent = count;
                        index++;
                    }
                }
            }
        }
    </script>
</body>
</html>
